name: Custom2.ESXi.Linux.AnomalousFiles
author: "ohelg"
description: |
   Modified default Linux artifact to work with ssh accessor
 
type: CLIENT
 
parameters:
   - name: ssh_hostname
     description: ESXi IP address and port
     default:
   - name: ssh_username
     description: account for SSH connection
     default:
   - name: ssh_password
     description: account password
     default:
   - name: ssh_key
     description: account private SSH key
     default:
   - name: MaxNormalSize
     description: Size (in bytes) above which a file is considered large
     type: int
     default: 10485760
   - name: PathsToSearch
     description: Paths to search, separated by comma
     type: str
     default: "/home/**,tmp/**,/**"    
      
sources:
    - query: |
        LET SSH_CONFIG <=dict(
            hostname=ssh_hostname,
            username=ssh_username,
            password=ssh_password
        )
         
        LET _ <= remap(config='''
        remappings:
            - type: mount
              from:
                accessor: ssh
              on:
                accessor: auto
        ''')
         
        SELECT Fqdn AS Host,
             OSPath,
             substr(str=Name, start=0, end=1) = "." AS IsHidden,
             Size,
             Size > MaxNormalSize AS IsLarge,
             Mode.String AS Mode,
             Mode =~ "^u" as HasSUID
        FROM glob(globs=split(string=PathsToSearch, sep_string=","))
        WHERE IsHidden OR IsLarge OR HasSUID