name: ACSC.Linux.ESXi.Velociraptor.SSH_accessor.VMs
description: |
  `Classication: OFFICIAL`
  `TLP: CLEAR`
  `Status: test` 
    
    This artifact allows Velociraptor to query ESXi VMs


author: ohelg

reference:
- https://www.synacktiv.com/en/publications/vmware-esxi-forensic-with-velociraptor

type: NOTEBOOK

sources:
    - notebook:
      - type: vql
        name: ESXi Upload logs
        template: |
            
            LET ssh_hostname = ""
            LET ssh_username = ""
            LET ssh_password = ""
            LET ssh_keyfile = ""
            LET config_file = "/etc/vmsyslog.conf"
            LET config_file_regex = "logdir="
            
            
            LET SSH_CONFIG <=dict(
                hostname=ssh_hostname,
                username=ssh_username,
                private_key=read_file(filename=ssh_keyfile))

            // USE THE BELOW IF YOU ARE USING A PASSWORD
            // LET SSH_CONFIG <=dict(
            //    hostname=ssh_hostname,
            //    username=ssh_username,
            //    password=ssh_password)


            LET _ <= remap(config='''
            remappings:
                - type: mount
                  from:
                    accessor: ssh 
                  on: 
                    accessor: auto
            ''')
            
            LET file_to_parse = SELECT OSPath FROM glob(globs=config_file)
            
            LET parse_config_file = SELECT * FROM foreach(row=file_to_parse,
                query={
                    SELECT Line FROM parse_lines(filename=OSPath)
                    WHERE 
                        Line =~ config_file_regex
                })
                
            LET log_path = SELECT split(string=Line,sep='=')[1] + "/*" AS FullPath FROM parse_config_file
            
            LET scratch = SELECT FullPath FROM log_path WHERE FullPath =~ "scratch"
            LET vmfs = SELECT FullPath FROM log_path WHERE FullPath =~ "vmfs"
            
            
            LET scrach_location = SELECT OSPath FROM glob(globs="/etc/vmware/locker.conf")
            LET parse_scrach_location = SELECT * FROM foreach(row=scrach_location,
                query={
                    SELECT Line FROM parse_lines(filename=OSPath)})
            
            LET real_scratch_path = SELECT split(string=Line,sep=' ')[0] +"/log/*" AS FullPath FROM parse_scrach_location
            
            LET real_path = SELECT * FROM if(condition=vmfs,
                then=vmfs,
                else=real_scratch_path
            )
            
            LET results = SELECT OSPath, Size,
                Mtime As Modifed,
                type AS Type,
                upload(file=OSPath,
                    accessor=accessor,
                    ctime=Ctime,
                    mtime=Mtime) AS FileDetails
            FROM glob(globs=real_path.FullPath, accessor="ssh")
            
            SELECT OSPath, Size, Modifed, Type,
                FileDetails.Path AS ZipPath,
                FileDetails.Md5 as Md5,
                FileDetails.Sha256 as SHA256
            FROM results
